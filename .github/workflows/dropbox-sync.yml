name: Dropbox-GitHub Daily Sync

on:
  # 1日1回実行 (Run once per day at 00:00 UTC)
  schedule:
    - cron: '0 0 * * *'
  
  # 手動実行も可能にする (Allow manual triggering)
  workflow_dispatch:
    inputs:
      target_directories:
        description: 'Target directories (comma-separated, optional)'
        required: false
        type: string
      sync_target_dir:
        description: 'Sync target directory (default: review)'
        required: false
        type: string
        default: 'review'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
    
    - name: Make Gradle Wrapper executable
      run: chmod +x ./gradlew
    
    - name: Build application
      run: ./gradlew build --no-daemon
    
    - name: Create config directory
      run: mkdir -p /tmp/config
    
    - name: Create configuration file
      run: |
        cat > /tmp/config/config.properties << EOF
        # Dropbox refresh token認証
        dropbox.refresh.token=${{ secrets.DROPBOX_REFRESH_TOKEN }}
        dropbox.client.id=${{ secrets.DROPBOX_CLIENT_ID }}
        dropbox.client.secret=${{ secrets.DROPBOX_CLIENT_SECRET }}
        
        # Dropbox access token認証
        dropbox.access.token=${{ secrets.DROPBOX_ACCESS_TOKEN }}
        
        # GitHub Personal Access Token
        github.pat=${{ secrets.GH_PAT }}
        
        # GitHubユーザー名
        github.username=${{ github.repository_owner }}
        
        # GitHubリモートURL
        github.remote.url=https://github.com/${{ github.repository }}.git
        
        # ローカルリポジトリのパス
        local.repo.path=/tmp/sync-repo
        
        # Dropboxカーソル情報ファイルのパス
        cursor.file.path=/tmp/cursor
        
        # 対象ファイル拡張子
        target.file.extensions=${{ secrets.TARGET_FILE_EXTENSIONS || '.zip,.java,.xlsx,.xlsm,.png,.txt' }}
        
        # 管理対象ディレクトリ
        target.directories=${{ inputs.target_directories || secrets.TARGET_DIRECTORIES || '' }}
        
        # Github-dropbox反映対象ディレクトリ
        sync.target.dir=${{ inputs.sync_target_dir || 'review' }}
        EOF
    
    - name: Create cursor directory
      run: mkdir -p /tmp/cursor
    
    - name: Create sync repository directory
      run: mkdir -p /tmp/sync-repo
    
    - name: Run synchronization
      run: |
        java -cp build/libs/db2ghsync.jar com.db2ghsync.DropboxGitSyncApplication /tmp/config/config.properties
      env:
        JAVA_OPTS: "-Xmx512m"
    
    - name: Upload sync logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sync-logs-${{ github.run_id }}
        path: |
          /tmp/config/config.properties
          /tmp/cursor/
        retention-days: 7
